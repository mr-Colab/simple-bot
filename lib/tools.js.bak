const fileType = require("file-type");
const FormData = require("form-data");
const fetch = require('node-fetch');

/**
 * Upload media buffer to Catbox. moe file hosting
 * @param {Buffer} buffer - The media buffer to upload
 * @returns {string} The URL of the uploaded file
 */
async function uploadMedia(buffer) {
  try {
    // Detect file extension from buffer
    const { ext } = await fileType.fromBuffer(buffer);
    
    // Prepare form data for upload
    const formData = new FormData();
    formData.append("fileToUpload", buffer, "file." + ext);
    formData.append('reqtype', "fileupload");
    
    // Upload to Catbox. moe
    const response = await fetch('https://catbox. moe/user/api.php', {
      method: "POST",
      body: formData
    });
    
    if (!response.ok) {
      throw new Error(`Upload failed with status ${response. status}: ${response. statusText}`);
    }
    
    // Return the file URL
    const fileUrl = await response. text();
    return fileUrl;
    
  } catch (error) {
    console.error("Error during media upload:", error);
    throw new Error("Failed to upload media");
  }
}

/**
 * Handle media upload with size validation
 * @param {Buffer} buffer - The media buffer to upload
 * @returns {string} The URL of the uploaded file or error message
 */
async function handleMediaUpload(buffer) {
  try {
    // Calculate file size in MB (1048576 bytes = 1 MB)
    const fileSizeMB = buffer. length / 1048576;
    
    // Check if file exceeds 200MB limit (0xc8 = 200)
    if (fileSizeMB > 200) {
      return "File size exceeds the limit of 200MB.";
    }
    
    // Upload and return URL
    const fileUrl = await uploadMedia(buffer);
    return fileUrl;
    
  } catch (error) {
    console.error("Error handling media upload:", error);
    throw new Error("Failed to handle media upload");
  }
}

module.exports = {
  uploadMedia,
  handleMediaUpload
};